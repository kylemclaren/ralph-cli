[tools]
go = "1.23"

[env]
VERSION = "{{exec(command='git describe --tags --always --dirty 2>/dev/null || echo dev')}}"
COMMIT = "{{exec(command='git rev-parse --short HEAD 2>/dev/null || echo unknown')}}"
BUILD_DATE = "{{exec(command='date -u +%Y-%m-%dT%H:%M:%SZ')}}"
LDFLAGS = "-X main.Version={{env.VERSION}} -X main.Commit={{env.COMMIT}} -X main.BuildDate={{env.BUILD_DATE}}"

[tasks.build]
description = "Build ralph binary"
run = "go build -ldflags \"$LDFLAGS\" -o ralph ./cmd/ralph"

[tasks.install]
description = "Install ralph to GOPATH/bin"
run = "go install -ldflags \"$LDFLAGS\" ./cmd/ralph"

[tasks.clean]
description = "Remove built binaries"
run = """
rm -f ralph
rm -rf dist/
"""

[tasks.test]
description = "Run tests"
run = "go test -v ./..."

[tasks.lint]
description = "Run linter"
run = "golangci-lint run"

[tasks.dist]
description = "Build for multiple platforms"
depends = ["clean"]
run = """
mkdir -p dist
GOOS=darwin GOARCH=arm64 go build -ldflags "$LDFLAGS" -o dist/ralph-darwin-arm64 ./cmd/ralph
GOOS=darwin GOARCH=amd64 go build -ldflags "$LDFLAGS" -o dist/ralph-darwin-amd64 ./cmd/ralph
GOOS=linux GOARCH=amd64 go build -ldflags "$LDFLAGS" -o dist/ralph-linux-amd64 ./cmd/ralph
GOOS=linux GOARCH=arm64 go build -ldflags "$LDFLAGS" -o dist/ralph-linux-arm64 ./cmd/ralph
GOOS=windows GOARCH=amd64 go build -ldflags "$LDFLAGS" -o dist/ralph-windows-amd64.exe ./cmd/ralph
"""

[tasks.init]
description = "Run ralph init in current directory"
depends = ["build"]
run = "./ralph init"

[tasks.default]
description = "Show available tasks"
run = "mise tasks"
